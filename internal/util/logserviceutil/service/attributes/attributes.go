package attributes

import (
	"github.com/milvus-io/milvus/internal/proto/logpb"
	"github.com/milvus-io/milvus/internal/util/sessionutil"
	"google.golang.org/grpc/attributes"
)

type attributesKeyType int

const (
	serverIDKey attributesKeyType = iota
	channelAssignmentInfoKey
	sessionKey
)

type Attributes = attributes.Attributes

var New = attributes.New

// GetServerID returns the serverID in the given Attributes.
func GetServerID(attr *attributes.Attributes) *int64 {
	val := attr.Value(serverIDKey)
	if val == nil {
		return nil
	}
	serverID := val.(int64)
	return &serverID
}

// WithChannelAssignmentInfo returns a new Attributes containing the given channelInfo.
func WithChannelAssignmentInfo(attr *attributes.Attributes, assignment *logpb.LogNodeAssignment) *attributes.Attributes {
	return attr.WithValue(channelAssignmentInfoKey, assignment).WithValue(serverIDKey, assignment.ServerID)
}

// GetChannelAssignmentInfoFromAttributes get the channel info fetched from logcoord.
// Generated by the channel assignment discoverer and sent to channel assignment balancer.
func GetChannelAssignmentInfoFromAttributes(attrs *attributes.Attributes) *logpb.LogNodeAssignment {
	val := attrs.Value(channelAssignmentInfoKey)
	if val == nil {
		return nil
	}
	return val.(*logpb.LogNodeAssignment)
}

// WithSession returns a new Attributes containing the given session.
func WithSession(attr *attributes.Attributes, val *sessionutil.Session) *attributes.Attributes {
	return attr.WithValue(sessionKey, val).WithValue(serverIDKey, val.ServerID)
}

// GetSessionFromAttributes get session from attributes.
func GetSessionFromAttributes(attrs *attributes.Attributes) *sessionutil.Session {
	val := attrs.Value(sessionKey)
	if val == nil {
		return nil
	}
	return val.(*sessionutil.Session)
}
